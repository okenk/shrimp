---
title: "Shrimp modeling"
output: html_notebook
---

```{r, include = FALSE}
library(rstan)
library(tidyverse)
load('../Code/model_output.Rdata')
```

## Data:
Data we have at month-year-fishing area resolution:

* Average length and sample size for each age class (1-3) from April to October, i.e., up to 21 observations of each year class in a given area, but some combinations are missing. This is from sampling the catch.
* SD for each age class from 2014-2018 (actually have individual data for each shrimp measured in these years)
* Total catch in lbs
* Count per pound
* Percent age composition of the catch by number
* All of this for 1989-2018, though a lot of pubs seems to have 1980-present

Here is a plot of the mean lengths at age by area and year class.

```{r, echo = FALSE, fig.height=10, fig.width = 5}
ggplot(length.fits, aes(x = Age_Month, y = Avg_Len, group = paste(Year_Class, Area), col = factor(Area))) +
  geom_path(lwd = .25) +
  geom_point(cex=.5) +
  facet_wrap(~Year_Class) +
  labs(x = 'Age (years)', y = 'Mean Length (mm)', color = 'State Area', lty = 'Age') +
  NULL
```
## Length model:
$L_{a,y,m}$ is length of age $a$ shrimp in month $m$ of year $y$. Then

$$\begin{aligned}
L_{1,y,1} &= \alpha_0 + \epsilon_{1,y,1} \\
L_{a,y,m} &= \alpha_1 + L_{a,y,m-1} + \epsilon_{a,y,m} \\
L_{a,y,1} &= \alpha_2 + L_{a-1, y-1, m_{\max}} + \epsilon_{a,y,1}
\end{aligned}$$

$\alpha_0$ is average size of age 1 shrimp in April, $\alpha_1$ is the monthly within fishing season monthly growth increment, and $\alpha_2$ is the across fishing season growth increment. Right now I assume $\alpha_1 = \alpha_2$, though I don't think that is correct as there is not much wintertime growth. I tried to also estimate $\beta_1$ and $\beta_2$ that get multiplied by length (i.e., mean reverting AR process instead of random walk), but $\alpha$ and $\beta$ were so tightly correlated it seemed pointless. (Could add it back in since it won't impact mixing-- Stan is great! Or is there a way to reparameterize?) All of these can be functions of environmental variables. There is also an existing theory that growth is density-dependent, so they grow less when there are more shrimp around. The process variability $\epsilon$ follows a normal distribution, and I estimate a separate $\sigma_\text{init size}$ and $\sigma_\text{growth}$.

## Observation model:

$$\bar{L}_{a,y,m,area} \sim N\left(L_{a,y,m}, \frac{\sigma_\text{obs}}{\sqrt{n_{a,y,m,area}}} \right) $$

where $\bar{L}_{a,y,m,area}$ is the empirical mean length for age $a$ in month $m$ of year $y$ sampled in area $area$, $\sigma_\text{obs}$ is the observation standard deviation, and $n_{a,y,m,area}$ is the number of age $a$ shrimp that were sampled from the catch in month $m$ of year $y$ in area $area$. 

## Fitting:

The model is fit in stan as a multivariate autoregressive state-space model. Each year class is a different "state," but the underlying parameters for each state are the same (for now). Each area represents a different observation process of the same state. 

#Results

First, here is a table of the estimated parameters. Note that the mixing on $\sigma_\text{growth}$ is not great.
```{r, echo = FALSE}
mod.summary <- summary(mod, pars = c('x0_mean', 'x0_sd', 'U', 'sigma_process', 'sigma_obs'))$summary
row.names(mod.summary) <- c('$\\alpha_0$', '$\\sigma_\\text{init size}$', '$\\alpha_1$', '$\\sigma_\\text{growth}$', '$\\sigma_\\text{obs}$')
knitr::kable(mod.summary)
```

Second, here is a plot of residuals versus fitted values (using the median from the posterior as the fitted value) with a smoother. We see that the residuals look alright. There does seems to be a negative skew at the high and low ends, but don't want to over-interpret...
```{r, echo = FALSE}
qplot(MedPredLength, Avg_Len - MedPredLength, data = length.fits, alpha = .5) + 
  stat_smooth() +
  geom_hline(yintercept = 0, col = 'red') +
  theme(legend.position = 'none') +
  NULL  
```


Finally, here is a plot of residuals split up by area. Unsuprisingly based on the plot of the data above, it looks as though some areas consistently have smaller shrimp than others. One possible way to handle this is to estimate an area-specific offset for the observation process that is constant across years. That is, assume:
$$\bar{L}_{a,y,m,area} \sim N\left(L_{a,y,m} + \gamma_{area}, \frac{\sigma_\text{obs}}{\sqrt{n_{a,y,m,area}}} \right) $$

```{r, echo = FALSE}
ggplot(length.fits) +
  geom_boxplot(aes(x = Area, y = Avg_Len - MedPredLength)) +
  geom_hline(yintercept = 0, col = 'red')
```

## Next steps:

The first thing to do is fix the problem where residuals vary systematically by fishing area. After that, I think it would be useful to begin thinking about potential environmental drivers of growth-- both early life history growth (i.e., $\alpha_0$), and within season growth (i.e., $\alpha_1$).
<!-- Martell et al. 2000 report annual M of 0.96 $\text{yr}^{-1}$, which is used in VPA.  -->

